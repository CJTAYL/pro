/*
Purpose: Query to retrieve information about members participating in the SMP program
Author: Chris Taylor
Original Query Date: 10/04/24
Criteria
- Opened in Durahm or Virtual Center
- Opened between Feb 1, 2024 and Dec 31, 2026
- Age >= 16
- Deposit at least $250
- Complete program application and sign disclaimer
- Warning Code = 36 or 38
- Account Relationship Code 18 = Employee 
*/

SET NOCOUNT ON

SELECT DISTINCT
    sav.PARENTACCOUNT as ParentAccount
	, dtl.AccountRelationshipCode
  , ID as ShareID
	, MIN(stran.SEQUENCENUMBER) as SequenceNumber
  , MAX(AccountPrimeLongName) as MemberName
	, MAX(DATEDIFF(year, BIRTHDATE, GETDATE())) as Age
  , WARNINGCODE1 as WarningCode
  , sav.BRANCH as Branch
	, CASE 
		WHEN sav.BRANCH = 701 THEN 'Charlotte Meridan'
		WHEN sav.BRANCH = 702 THEN 'Charlotte University'
		WHEN sav.BRANCH = 702 THEN 'Greensboro West Market'
		WHEN sav.BRANCH = 704 THEN 'Fayetteville'
		WHEN sav.BRANCH = 705 THEN 'Greensboro West Gate'
		WHEN sav.BRANCH = 706 THEN 'High Point'
		WHEN sav.BRANCH = 708 THEN 'Charlotte Milton'
		WHEN sav.BRANCH = 714 THEN 'Winston Salem'
		WHEN sav.BRANCH = 717 THEN 'Durham'
		WHEN sav.BRANCH = 720 THEN 'Operations'
		WHEN sav.BRANCH = 721 THEN 'Virtual Center (Raleigh)'
		WHEN sav.BRANCH = 737 THEN 'Raleigh'
		WHEN sav.BRANCH = 747 THEN 'Garner'
		WHEN sav.BRANCH = 751 THEN 'Monroe'
		WHEN sav.BRANCH = 771 THEN 'Charlotte South'
		WHEN sav.BRANCH = 777 THEN 'North Durham'
		WHEN sav.BRANCH = 790 THEN 'Carrboro'
		ELSE 'No Branch Available'
	END as BranchDescription
  , CAST(sav.OPENDATE as DATE) as OpenDate
  , CAST(ORIGINALDEPOSITDATE as DATE) as OriginalDepositDate
  , MIN(ORIGINALDEPOSIT) as OriginalDeposit
	, MAX(BALANCE) as CurrentBalance
	, CASE
		WHEN BALANCE >= 2 * ORIGINALDEPOSIT THEN 'N'
		ELSE 'Y'
	END as PotentialIssue -- Y could indicate funds were not matched or participant withdrew deposit early
FROM 
    ARCUSYM000.dbo.SAVINGS sav 
INNER JOIN 
    ARCUSYM000.arcu.ARCUMemberAccountDetailed mdtl ON sav.PARENTACCOUNT = mdtl.AccountNumber AND sav.ProcessDate = mdtl.ProcessDate
INNER JOIN  
    ARCUSYM000.arcu.ARCUMemberSupp supp ON mdtl.MemberSuppID = supp.MemberSuppID AND mdtl.ProcessDate = supp.ProcessDate
INNER JOIN 
    ARCUSYM000.arcu.ARCUAccountDetailed dtl ON sav.PARENTACCOUNT = dtl.AccountNumber AND sav.ProcessDate = dtl.ProcessDate
INNER JOIN 
	ARCUSYM000.dbo.SAVINGSTRANSACTION stran ON stran.PARENTACCOUNT = sav.PARENTACCOUNT AND stran.BALANCECHANGE = sav.ORIGINALBALANCE AND stran.POSTDATE = sav.ORIGINALDEPOSITDATE
WHERE 
  dtl.AccountRelationshipCode != 18
	AND sav.OPENDATE >= '2024-02-01' 
	AND sav.OPENDATE <= '2026-12-31'
  AND WARNINGCODE1 != 900
  AND (WARNINGCODE1 = 36 OR WARNINGCODE1 = 38)
	AND sav.ProcessDate = 20250114 -- most recent process date at time of query
GROUP BY 
	sav.ParentAccount 
	, AccountRelationshipCode
	, ID 
	--, SequenceNumber 
	, sav.BRANCH
	, CAST(ORIGINALDEPOSITDATE as DATE)
	, CAST(sav.OPENDATE as DATE)
	, WARNINGCODE1
	, CASE 
		WHEN sav.BRANCH = 701 THEN 'Charlotte Meridan'
		WHEN sav.BRANCH = 702 THEN 'Charlotte University'
		WHEN sav.BRANCH = 702 THEN 'Greensboro West Market'
		WHEN sav.BRANCH = 704 THEN 'Fayetteville'
		WHEN sav.BRANCH = 705 THEN 'Greensboro West Gate'
		WHEN sav.BRANCH = 706 THEN 'High Point'
		WHEN sav.BRANCH = 708 THEN 'Charlotte Milton'
		WHEN sav.BRANCH = 714 THEN 'Winston Salem'
		WHEN sav.BRANCH = 717 THEN 'Durham'
		WHEN sav.BRANCH = 720 THEN 'Operations'
		WHEN sav.BRANCH = 721 THEN 'Virtual Center (Raleigh)'
		WHEN sav.BRANCH = 737 THEN 'Raleigh'
		WHEN sav.BRANCH = 747 THEN 'Garner'
		WHEN sav.BRANCH = 751 THEN 'Monroe'
		WHEN sav.BRANCH = 771 THEN 'Charlotte South'
		WHEN sav.BRANCH = 777 THEN 'North Durham'
		WHEN sav.BRANCH = 790 THEN 'Carrboro'
		ELSE 'No Branch Available'
	END
	, CASE
		WHEN BALANCE >= 2 * ORIGINALDEPOSIT THEN 'N'
		ELSE 'Y'
	END
ORDER BY
	sav.PARENTACCOUNT
