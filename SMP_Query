/*
Purpose: Query to identify share term certificates with Warning Code 038, which is associated with the Savings Match Program (SMP)
Author: Chris Taylor
Date: 12/12/2024
Updated: 01/15/2025
*/

WITH recent_smp (member_name, account_number, sequence_number, share_branch, open_date, share_type, share_description, orig_balance, current_balance, RN) as (

select distinct
  SharePrimeNameLongName 
  , SD.AccountNumber
  , stran.sequencenumber
  --, ShareID
  --, ShareWarningcode1
  , ShareBranchFullDescription
  , ShareOpenDate
  , ShareType
  , ShareTypeDescription
  , ShareOriginalBalance
  , ShareBalance
  , row_number() over(partition by SD.AccountNumber, ShareID order by SD.ProcessDate desc) -- Label the data for individual accounts by process date descending
from arcusym000.arcu.ARCUShareDetailed as SD
inner join arcusym000.arcu.ARCUAccountDetailed as AD on SD.ProcessDate = AD.ProcessDate and SD.AccountNumber = AD.AccountNumber
inner join arcusym000.dbo.SAVINGSTRANSACTION as stran ON stran.PARENTACCOUNT = SD.AccountNumber AND stran.BALANCECHANGE = SD.ShareOriginalBalance AND stran.POSTDATE = SD.ShareOriginalDepositDate
where 
  ShareType in (1006, 1106)
  and ShareOriginalBalance between 250 and 750 -- Not sure if this will be too narrow
  and (ShareWarningcode1 = 038 or 
  AccountWarningcode1 = 038 or 
  AccountWarningcode2 = 038 or 
  AccountWarningcode3 = 038 or 
  AccountWarningcode4 = 038 or 
  AccountWarningcode5 = 038 or 
  AccountWarningcode6 = 038 or 
  AccountWarningcode7 = 038 or 
  AccountWarningcode8 = 038 or 
  AccountWarningcode9 = 038 or 
  AccountWarningcode10 = 038 or 
  AccountWarningcode11 = 038 or 
  AccountWarningcode12 = 038 or 
  AccountWarningcode13 = 038 or 
  AccountWarningcode14 = 038 or 
  AccountWarningcode15 = 038 or 
  AccountWarningcode16 = 038 or 
  AccountWarningcode17 = 038 or 
  AccountWarningcode18 = 038 or
  AccountWarningcode19 = 038 or 
  AccountWarningcode20 = 038
  )
)

select distinct
  member_name
  , account_number 
  , share_branch
  , orig_balance 
  , current_balance
  , open_date
  , share_description
from recent_smp 
where RN = 1 -- Return data with the most recent process date
order by 
  member_name
